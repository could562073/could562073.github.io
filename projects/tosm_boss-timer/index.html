<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>救世者之樹 m - 野王計時器</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --brand:#22d3ee; --accent:#a78bfa; --ok:#34d399; --warn:#f59e0b; --danger:#ef4444;
    --card:#0b1220; --ring:rgba(34,211,238,.4); --shadow:0 10px 30px rgba(0,0,0,.35);
    font-synthesis-weight:none;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 600px at 20% -10%, rgba(167,139,250,.14), transparent 60%),
                radial-gradient(900px 500px at 110% 20%, rgba(34,211,238,.12), transparent 60%),
                var(--bg);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Microsoft JhengHei", "Noto Sans TC", Arial, "PingFang TC", sans-serif;
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{max-width:1200px; margin:28px auto; padding:0 20px;}
  header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; justify-content:space-between; gap:16px;
    margin-bottom:14px; padding:12px 0;
    background:linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,0));
    backdrop-filter:saturate(120%) blur(2px);
  }
  h1{font-size:clamp(18px,2.6vw,28px); margin:0; letter-spacing:.5px}
  .now{font-variant-numeric:tabular-nums; color:var(--muted); font-size:13px}

  .grid{display:grid; gap:18px; grid-template-columns: 380px 1fr;}
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), var(--panel);
    border:1px solid rgba(255,255,255,.06);
    border-radius:18px; padding:18px; box-shadow:var(--shadow);
  }

  /* 左側 */
  .meta{display:grid; gap:14px}
  .kv{display:grid; gap:8px}
  .kv label{font-size:13px; color:var(--muted)}

  .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
  /* 新的三欄：A / B / 分流+色塊 */
  .row3{grid-template-columns: 1fr 1fr auto;}
  .laneWrap{display:flex; align-items:center; gap:8px;}
  .laneWrap .input{width:76px; text-align:center}
  .swatch{
    width:28px; height:28px; border-radius:8px; border:1px solid rgba(255,255,255,.2);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.2);
  }

  .triple{display:grid; grid-template-columns: repeat(3,1fr); gap:10px;}
  .input, select{
    width:100%; padding:12px 12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.08);
    background:var(--card); color:var(--text);
    outline:none; transition: .15s border, .15s box-shadow, .15s transform;
    font-size:15px;
  }
  select{ white-space:normal; word-break:break-word; }
  .input:focus, select:focus{ border-color:var(--brand); box-shadow:0 0 0 4px var(--ring); }

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
    background: linear-gradient(180deg, rgba(34,211,238,.22), rgba(34,211,238,.12));
    color:#052026; font-weight:600; letter-spacing:.3px; cursor:pointer;
    transition: .15s transform, .15s filter, .15s box-shadow; box-shadow:var(--shadow);
    touch-action:manipulation;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn-outline{background:transparent; color:var(--brand); border-color:rgba(34,211,238,.35)}
  .btn-row{display:flex; gap:10px; flex-wrap:wrap}

  /* 讓「立即新增」更醒目 */
  #btnQuickAdd{
    background: radial-gradient(80% 120% at 50% -10%, rgba(167,139,250,.35), transparent 60%),
                linear-gradient(180deg, rgba(34,211,238,.35), rgba(34,211,238,.16));
    border-color: rgba(34,211,238,.55);
    box-shadow: 0 0 0 4px rgba(34,211,238,.18), 0 12px 26px rgba(0,0,0,.35);
    font-weight:800;
  }
  #btnQuickAdd:hover{ filter:brightness(1.08) }
  #btnQuickAdd:active{ transform: translateY(1px) }

  .hint{font-size:12px; color:var(--muted); margin-top:4px}

  /* 右側清單 */
  .list{display:grid; gap:12px;}
  .card{
    position:relative; display:grid; gap:6px;
    padding:14px 16px; border-radius:14px;
    background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 50%), var(--card);
    border:1px solid rgba(255,255,255,.06);
  }
  .title{font-weight:600; letter-spacing:.3px}
  .row2{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .count{font-variant-numeric:tabular-nums; font-size:18px; letter-spacing:.5px}
  .soon .count{ color:var(--warn)}
  .expired .count{ color:var(--danger)}
  .badge{
    font-size:12px; padding:2px 8px; border-radius:999px;
    background:rgba(167,139,250,.15); color:var(--accent);
    border:1px solid rgba(167,139,250,.35)
  }
  .tools{display:flex; gap:8px}
  .iconbtn{
    width:36px; height:36px; display:inline-grid; place-items:center; border-radius:10px;
    border:1px solid rgba(255,255,255,.08); background:transparent; color:var(--muted);
    cursor:pointer; touch-action:manipulation;
  }
  .iconbtn:hover{color:#fff; border-color:rgba(255,255,255,.24)}
  .empty{text-align:center; color:var(--muted); padding:24px 8px; border:1px dashed rgba(255,255,255,.12); border-radius:14px}

  /* Modal（完整填單仍可用） */
  .modal{position:fixed; inset:0; display:none; place-items:center; z-index:50; background:rgba(3,7,18,.55); backdrop-filter: blur(2px);}
  .modal.open{display:grid}
  .sheet{width:min(680px, 92vw); background:var(--panel); border:1px solid rgba(255,255,255,.09); border-radius:18px; padding:18px; box-shadow:var(--shadow)}
  .sheet h2{margin:0 0 10px 0}
  .sheet .grid2{display:grid; gap:12px; grid-template-columns: 1fr 1fr}
  .sheet .footer{display:flex; justify-content:flex-end; gap:10px; margin-top:6px}
  .req::after{content:"*"; color:var(--danger); margin-left:2px}
  .small{font-size:12px; color:var(--muted)}

  /* RWD */
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  @media (max-width:640px){
    .wrap{padding:0 14px}
    .panel{padding:14px; border-radius:16px}
    .row{grid-template-columns:1fr; gap:8px}
    /* 行動：三欄自動改為直排 */
    .row3{grid-template-columns:1fr}
    .triple{grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px}
    .btn{width:100%}
    .btn-row{flex-direction:column}
    .iconbtn{width:40px; height:40px}
    .count{font-size:20px}
    .sheet{width:100vw; max-width:100vw; border-radius:16px 16px 0 0; padding:16px; align-self:end}
    .sheet .grid2{grid-template-columns:1fr}
  }

  /* 題頭右上的主題切換按鈕 */
.tbtn{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:8px 12px; border-radius:999px; cursor:pointer;
  border:1px solid rgba(255,255,255,.18);
  background:linear-gradient(180deg, rgba(34,211,238,.25), rgba(34,211,238,.12));
  color:#052026; font-weight:700; letter-spacing:.2px;
  box-shadow:0 6px 18px rgba(0,0,0,.25);
}
body.light .tbtn{
  border-color:rgba(0,0,0,.08);
  background:linear-gradient(180deg, rgba(2,132,199,.18), rgba(2,132,199,.08));
  color:#0f172a; box-shadow:0 6px 18px rgba(2,132,199,.15);
}

/* —— 淺色主題：覆寫變數 —— */
body.light{
  --bg:#f5f7fb;          /* 淺底 */
  --panel:#ffffff;       /* 主要面板 */
  --card:#ffffff;        /* 卡片 */
  --text:#0f172a;        /* 深字 */
  --muted:#475569;       /* 次要字 */
  --ring:rgba(2,132,199,.25);
  --shadow:0 10px 30px rgba(15,23,42,.08);
}
/* 讓 header 背景在淺色時更乾淨 */
body.light header{
  background:linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,0));
  backdrop-filter:saturate(120%) blur(4px);
}
/* 卡片邊框在淺色時更淡一點 */
body.light .panel,
body.light .card{ border-color: rgba(15,23,42,.08); }
/* 空清單提示的虛線框在淺色時 */
body.light .empty{ border-color: rgba(15,23,42,.12); color:#64748b; }
/* 通用：把瀏覽器預設按鈕外觀關掉 */
button {
  font: inherit;
}
.iconbtn{
  -webkit-appearance: none;
  appearance: none;
  background: transparent;
  outline: none;
  line-height: 1;
}

/* 膠囊小按鈕（重置/延後用） */
.iconbtn.chip{
  min-width: 40px;
  height: 32px;
  padding: 0 10px;
  border-radius: 999px;
  border: 1px solid rgba(34,211,238,.35);
  background: linear-gradient(180deg, rgba(34,211,238,.22), rgba(34,211,238,.12));
  color: #052026;
  font-weight: 700;
  box-shadow: 0 1px 0 rgba(0,0,0,.06);
}
.iconbtn.chip:hover{ filter: brightness(1.05); }
/* 白樣式下，hover 保持深色字體 */
body.light .btn:hover { 
  color:#000;    /* 或 #0f172a，比較柔和的黑 */
}

body.light .iconbtn:hover {
  color:#000;    /* 保持可見 */
  border-color:rgba(0,0,0,.24);
}
.iconbtn.chip:active{ transform: translateY(1px); }
.iconbtn.chip:focus-visible{ box-shadow: 0 0 0 3px rgba(34,211,238,.25); }

/* 白樣式下的對比 */
body.light .iconbtn.chip{
  border-color: rgba(2,132,199,.30);
  background: linear-gradient(180deg, rgba(2,132,199,.18), rgba(2,132,199,.08));
  color: #0f172a;
}

/* 刪除維持淡淡灰色（但也關閉預設外觀） */
.iconbtn.danger{
  -webkit-appearance: none; appearance: none;
  width: 36px; height: 32px; padding: 0;
  border-radius: 8px;
  border: 1px solid rgba(0,0,0,.10);
  background: transparent; color: #64748b;
}
body:not(.light) .iconbtn.danger{ border-color: rgba(255,255,255,.14); color: var(--muted); }
.iconbtn.danger:hover{ filter: brightness(1.1); }

</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>救世者之樹 m - 野王計時器</h1>
      <div style="display:flex; align-items:center; gap:10px;">
        <button id="themeToggle" class="tbtn" type="button" aria-pressed="false" title="切換主題">☀️ 日間</button>
        <div class="now" id="now">—</div>
      </div>
    </header>
    <div class="grid">
      <!-- 左邊：操作/說明 -->
      <section class="panel">
        <div class="meta">

          <div class="kv">
            <label>快速新增</label>
            <!-- 三欄：A / B / 分流+顏色 -->
            <div class="row row3">
              <select id="quickA" class="input" title="主分類 (A)"></select>
              <select id="quickB" class="input" title="次分類 (B)"></select>
              <div class="laneWrap">
                <input id="lane" class="input" type="number" min="1" value="1" title="分流">
                <span id="laneSwatch" class="swatch" title="此次分流顏色"></span>
              </div>
            </div>
          </div>

          <div class="kv">
            <label>預設重生時間 (小時/分/秒)</label>
            <div class="triple">
              <input id="dH" class="input" type="number" min="0" value="0" />
              <input id="dM" class="input" type="number" min="0" value="5" />
              <input id="dS" class="input" type="number" min="0" value="0" />
            </div>
            <div class="hint">此區只影響「快速新增」，真正的倒數以每個項目建立時的設定為準。</div>
          </div>

          <div class="row">
            <!-- 已把分流移上去，這裡只留提醒分 -->
            <div class="kv" style="grid-column:1/-1">
              <label>提醒時間 (分)</label>
              <input id="leadMin" class="input" type="number" min="0" value="0" />
            </div>
          </div>

          <div class="kv">
            <div class="btn-row">
              <button id="btnQuickAdd" class="btn" type="button">➕ 立即新增</button>
              <button id="btnOpenForm" class="btn btn-outline" type="button">📝 詳細設定</button>
            </div>
            <div class="hint">直接用上方的快速欄位按「立即新增」；若要微調不同數值，可點「詳細設定」。</div>
          </div>

          <div class="kv">
            <button id="btnClear" class="btn btn-outline" type="button">🧹 清空所有計時</button>
            <div class="hint">所有資料會存入 Cookie（保存 1 年）。</div>
          </div>
        </div>
      </section>

      <!-- 右邊：清單 -->
      <section class="panel">
        <div id="list" class="list"></div>
        <div id="empty" class="empty" style="display:none">目前沒有計時，點左邊「立即新增」開始吧！</div>
      </section>
    </div>
  </div>

  <!-- Modal 表單（可選） -->
  <div class="modal" id="modal">
    <div class="sheet">
      <h2>新增計時（詳細設定）</h2>
      <div class="grid2">
        <div class="kv">
          <label class="req">主分類 A</label>
          <select id="formA" class="input"></select>
        </div>
        <div class="kv">
          <label class="req">次分類 B</label>
          <select id="formB" class="input"></select>
        </div>

        <div class="kv">
          <label class="req">重生時間（時 / 分 / 秒）</label>
          <div class="triple">
            <input id="formH" class="input" type="number" min="0" value="0">
            <input id="formM" class="input" type="number" min="0" value="5">
            <input id="formS" class="input" type="number" min="0" value="0">
          </div>
          <div class="small">建立後即開始倒數。</div>
        </div>

        <div class="kv">
          <label>分流</label>
          <input id="formLane" class="input" type="number" min="1" value="1">
        </div>

        <div class="kv">
          <label>提醒時間（分）</label>
          <input id="formLead" class="input" type="number" min="0" value="0">
        </div>
      </div>
      <div class="footer">
        <button id="btnCancel" class="btn btn-outline" type="button">取消</button>
        <button id="btnAdd" class="btn" type="button">新增計時</button>
      </div>
    </div>
  </div>

  <!-- 使用外部 mp3 音效 -->
  <audio id="beep" preload="auto">
    <source src="https://www.pacdv.com/sounds/interface_sound_effects/sound28.mp3" type="audio/mp3">
  </audio>
<div id="counter"></div>
<script>
/* ===== 主題切換：深/淺色 ===== */
const THEME_KEY = 'theme';
function applyTheme(theme){
  if(theme === 'light'){ document.body.classList.add('light'); }
  else{ document.body.classList.remove('light'); theme = 'dark'; }
  localStorage.setItem(THEME_KEY, theme);
  updateThemeToggleUI();
}
function updateThemeToggleUI(){
  const btn = document.getElementById('themeToggle');
  if(!btn) return;
  const isLight = document.body.classList.contains('light');
  btn.textContent = isLight ? '🌙 夜間' : '☀️ 日間';
  btn.setAttribute('aria-pressed', String(isLight));
  btn.title = isLight ? '切換到深色模式' : '切換到淺色模式';
}
// 初始：拿使用者設定，否則跟隨系統
(function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  const sysLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
  applyTheme(saved || (sysLight ? 'light' : 'dark'));
  // 按鈕事件
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'themeToggle'){
      const isLight = document.body.classList.contains('light');
      applyTheme(isLight ? 'dark' : 'light');
    }
  });
})();

/* -------------------- 小工具：Cookie -------------------- */
const COOKIE_KEY = "bossTimers_v1";
const COOKIE_FORM = "bossForm_v1";
function setCookie(name, value, days=365){
  const expires = new Date(Date.now()+days*864e5).toUTCString();
  document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}; expires=${expires}; path=/; samesite=lax`;
}
function getCookie(name){
  const m = document.cookie.match(new RegExp('(?:^|; )'+encodeURIComponent(name)+'=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : "";
}

/* -------------------- 資料模型 -------------------- */
let timers = []; // {id, a, b, lane, laneColor, durationMs, leadMin, startAt, alert1Fired, alert2Fired}
const $ = s => document.querySelector(s);
const listEl = $('#list');
const emptyEl = $('#empty');
const beepEl = $('#beep');

/* -------------------- 主/次選單資料 -------------------- */
const B_DICT = {
  "Episode 1": [
    "夏奧雷伊西邊森林 Lv.1 - 卑劣的 赤紅布貝門士",
    "夏奧雷伊東邊森林 Lv.3 - 強韌的 惡靈君主",
    "蓮帕拉沙池塘 Lv.5 - 不祥的 次元裂縫"
  ],
  "Episode 2": [
    "斯拉屋塔斯峽谷 Lv.10 - 卑劣的 獨眼巨人",
    "凱利高原 Lv.11 - 強韌的 瑪爾雷飛龍",
    "奈普里塔斯懸崖 Lv.12 - 強韌的 地獄亡靈",
    "泰內花園 Lv.13 - 強韌的 王座大蜘蛛",
    "泰內聖堂地下1層 Lv.15 - 強韌的 豬籠草"
  ],
  "Episode 3": [
    "庫魯森林 Lv.20 - 卑劣的 木乃伊賽西特",
    "克尼多斯森林 Lv.21 - 強韌的 伊堤斯大嘴獸",
    "達巴森林 Lv.22 - 強韌的 維尼亞猴子",
    "諾巴哈公會所 Lv.24 - 不祥的 次元裂縫",
    "諾巴哈本院 Lv.28 - 憤怒的 死亡魔女"
  ],
  "Episode 4": [
    "貝雅山谷 Lv.30 - 卑劣的 女妖克萊默",
    "比爾塔溪谷 Lv.31 - 不祥的 次元裂縫",
    "科博爾特森林 Lv.32 - 強韌的 魔斯怪",
    "培爾克神殿 Lv.36 - 強韌的 毒魔蛙",
    "安森塔冰源地 Lv.38 - 憤怒的 水蛭"
  ],
  "Episode 5": [
    "萊塔斯小溪 Lv.42 - 不祥的 次元裂縫",
    "德慕爾佃農村 Lv.44 - 卑劣的 地心蠕王",
    "德慕爾莊園 Lv.46 - 強韌的 克萊擔怪",
    "德慕爾外城 Lv.48 - 憤怒的 赤紅雷班扎特"
  ],
  "Episode 6": [
    "達伊納養蜂地 Lv.50 - 卑劣的 孟提肯",
    "比爾那森林 Lv.51 - 強韌的 塔奧瑪斯",
    "烏奇斯耕耘作地 Lv.52 - 不祥的 次元裂縫",
    "春光樹林 Lv.53 - 憤怒的 佛蘭普",
    "關口路 Lv.55 - 強韌的 切波勒",
    "史爾特凱拉森林 Lv.57 - 強韌的 亞魯"
  ],
  "Episode 7": [
    "魯卡斯高原 Lv.60 - 卑劣的 貝亞卡拉斯",
    "王之高原 Lv.61 - 強韌的 塚主洛德",
    "札卡里耶耶爾交叉路 Lv.62 - 不祥的 次元裂縫",
    "王陵1層 Lv.64 - 強韌的 庫勒卡斯",
    "王陵2層 Lv.66 - 憤怒的 雷克西波",
    "王陵3層 Lv.68"
  ],
  "Episode 8": [
    "阿雷魯諾男爵領 Lv.70 - 卑劣的 巨魔蟻",
    "水路橋地區 Lv.70 - 強韌的 克洛提德",
    "魔族收監所第1區 Lv.71 - 強韌的 布爾魯",
    "魔族收監所第3區 Lv.72 - 卑劣的 努亞耶雷",
    "魔族收監所第4區 Lv.73 - 強韌的 迪歐尼斯",
    "魔族收監所第5區 Lv.74 - 憤怒的 哈勒克"
  ],
  "Episode 9": [
    "女神的古院 Lv.75 - 強韌的 死靈查普利",
    "佩迪米安外城 Lv.76 - 卑劣的 惡魔葛洛夫",
    "魔法師之塔1層 Lv.77 - 強韌的 火焰蜘蛛王",
    "魔法師之塔2層 Lv.78 - 強韌的 瑪因洛德",
    "魔法師之塔3層 Lv.79 - 憤怒的 林嘉塞露女妖"
  ],
  "Episode 10": [
    "大教堂懺悔路 Lv.80 - 卑劣的 嘎拉庫曼",
    "大教堂正殿 Lv.81 - 強韌的 火焰權杖",
    "大教堂大迴廊 Lv.82 - 強韌的 利泰力斯",
    "大教堂至聖所 Lv.83 - 憤怒的 那柯提斯"
  ]
};
const A_OPTIONS = Object.keys(B_DICT);

/* -------------------- 隨機色與對比色 -------------------- */
const COLOR_POOL = ['#22d3ee','#a78bfa','#34d399','#f59e0b','#ef4444','#60a5fa','#f472b6','#84cc16','#eab308','#fb7185'];
function randomColor(){ return COLOR_POOL[Math.floor(Math.random()*COLOR_POOL.length)]; }
function textColorFor(hex){
  // 簡易 YIQ 對比：> 150 用深字，否則白字
  const c = hex.replace('#','');
  const r = parseInt(c.substring(0,2),16);
  const g = parseInt(c.substring(2,4),16);
  const b = parseInt(c.substring(4,6),16);
  const yiq = (r*299 + g*587 + b*114)/1000;
  return yiq >= 150 ? '#0b1220' : '#ffffff';
}

/* -------------------- 初始化選單 -------------------- */
function fillA(sel){
  sel.innerHTML = A_OPTIONS.map(v=>`<option value="${v}">${v}</option>`).join('');
}
function fillB(sel, aValue){
  const arr = B_DICT[aValue] || [];
  sel.innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join('');
}

/* -------------------- 儲存 / 載入 -------------------- */
function save(){ setCookie(COOKIE_KEY, JSON.stringify(timers)); }
function load(){
  const raw = getCookie(COOKIE_KEY);
  timers = raw ? JSON.parse(raw) : [];
}

function saveFormState(){
  const state = {
    quickA: $('#quickA').value,
    quickB: $('#quickB').value,
    dH: +$('#dH').value||0,
    dM: +$('#dM').value||0,
    dS: +$('#dS').value||0,
    lane: +$('#lane').value||1,
    leadMin: +$('#leadMin').value||0
  };
  setCookie(COOKIE_FORM, JSON.stringify(state));
}
function loadFormState(){
  const raw = getCookie(COOKIE_FORM);
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    if(s.quickA){ $('#quickA').value = s.quickA; fillB($('#quickB'), s.quickA); }
    if(s.quickB){ $('#quickB').value = s.quickB; }
    ['dH','dM','dS','lane','leadMin'].forEach(k=>{
      if(s[k]!==undefined) $('#'+k).value = s[k];
    });
  }catch{}
}

/* -------------------- 渲染 -------------------- */
function fmt(ms){
  if(ms<0) ms=0;
  const t = Math.floor(ms/1000);
  const h = Math.floor(t/3600).toString().padStart(2,'0');
  const m = Math.floor((t%3600)/60).toString().padStart(2,'0');
  const s = (t%60).toString().padStart(2,'0');
  return `${h}:${m}:${s}`;
}
function fmtClock(ts){
  const d = new Date(ts);
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}
function render(){
  const now = Date.now();
  const sorted = [...timers].sort((x,y)=>{
    const rx = x.startAt + x.durationMs - now;
    const ry = y.startAt + y.durationMs - now;
    const ax = Math.max(rx, -1);
    const ay = Math.max(ry, -1);
    return ax - ay;
  });

  listEl.innerHTML = '';
  if(sorted.length===0){ emptyEl.style.display='block'; return; }
  emptyEl.style.display='none';

  sorted.forEach(t=>{
    const remain = t.startAt + t.durationMs - now;
    const soon = remain <= t.leadMin*60*1000 && remain>0;
    const expired = remain<=0;

    const card = document.createElement('div');
    card.className = 'card' + (soon?' soon':'') + (expired?' expired':'');
    const endAt = t.startAt + t.durationMs;

    // 分流色樣式
    const color = t.laneColor || '#a78bfa';
    const badgeBg = color;
    const badgeText = textColorFor(color);
    const borderCol = color;

    card.innerHTML = `
      <div class="row2">
        <div class="title">
          ${t.a} - ${t.b}
          <span class="badge" style="
            background:${badgeBg};
            color:${badgeText};
            border-color:${borderCol};
          ">分流 ${t.lane}</span>
        </div>
        <div class="tools">
          <button class="iconbtn" title="重置（同設定）" data-act="reset" data-id="${t.id}">🔁</button>
          <button class="iconbtn" title="延後 1 分鐘" data-act="plus1" data-id="${t.id}">+1</button>
          <button class="iconbtn" title="延後 5 分鐘" data-act="plus5" data-id="${t.id}">+5</button>
          <button class="iconbtn" title="刪除" data-del="${t.id}">🗑️</button>
        </div>
      </div>
      <div class="row2">
        <div class="count">${fmt(remain)}</div>
        <div class="small">提醒：${t.leadMin} 分｜到點：<b>${fmtClock(endAt)}</b></div>
      </div>
    `;
    listEl.appendChild(card);
  });
}

/* -------------------- 計時循環 / 提醒 -------------------- */
function tick(){
  const now = Date.now();
  timers.forEach(t=>{
    const alertAt = t.startAt + t.durationMs - t.leadMin*60*1000;
    if(!t.alert1Fired && t.leadMin>0 && now >= alertAt && now < t.startAt + t.durationMs){
      t.alert1Fired = true; try{ beep.currentTime=0; beep.play(); }catch{}
    }
    if(!t.alert2Fired && now >= t.startAt + t.durationMs){
      t.alert2Fired = true; try{ beep.currentTime=0; beep.play(); }catch{}
    }
  });
  render();
}
setInterval(()=>{ $('#now').textContent = new Date().toLocaleString(); tick(); }, 1000);

/* -------------------- 建立 / 刪除 -------------------- */
function addTimer(data){
  const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random());
  timers.push({
    id,
    a: data.a,
    b: data.b,
    lane: +data.lane||1,
    laneColor: data.color || randomColor(),
    durationMs: ((+data.h||0)*3600 + (+data.m||0)*60 + (+data.s||0)) * 1000,
    leadMin: +data.lead||0,
    startAt: Date.now(),
    alert1Fired:false,
    alert2Fired:false
  });
  save(); render();
}
function deleteTimer(id){
  timers = timers.filter(t=>t.id!==id);
  save(); render();
}
listEl.addEventListener('click', (e)=>{
  const delId = e.target?.dataset?.del;
  if (delId) { deleteTimer(delId); return; }

  const act = e.target?.dataset?.act;
  const id  = e.target?.dataset?.id;
  if (!act || !id) return;

  const t = timers.find(x=>x.id===id);
  if (!t) return;

  const now = Date.now();
  if (act === 'reset') {
    t.startAt = now; t.alert1Fired = false; t.alert2Fired = false;
  } else if (act === 'plus1') {
    t.startAt += 60 * 1000; t.alert2Fired = false;
  } else if (act === 'plus5') {
    t.startAt += 5 * 60 * 1000; t.alert2Fired = false;
  }
  save(); render();
});

/* -------------------- 快速新增（不彈窗，無確認） -------------------- */
let currentLaneColor = randomColor();
const laneSwatch = document.getElementById('laneSwatch');
function updateLaneSwatch(){ laneSwatch.style.background = currentLaneColor; laneSwatch.title = `此次分流顏色：${currentLaneColor}`; }
function quickAdd(){
  const data = {
    a: $('#quickA').value,
    b: $('#quickB').value,
    h: +$('#dH').value||0,
    m: +$('#dM').value||0,
    s: +$('#dS').value||0,
    lane: +$('#lane').value||1,
    lead: +$('#leadMin').value||0,
    color: currentLaneColor
  };
  if((data.h+data.m+data.s)===0){ alert('重生時間不可為 0'); return; }
  addTimer(data);
  saveFormState();
  // 下一次新增換一個顏色
  currentLaneColor = randomColor();
  updateLaneSwatch();
}

/* -------------------- 表單（可選） -------------------- */
const modal = $('#modal');
const openModal = ()=>{ modal.classList.add('open'); syncFormFromQuick(); };
const closeModal = ()=>{ modal.classList.remove('open'); };

$('#btnOpenForm').addEventListener('click', ()=>{ openModal(); try{beep.play().catch(()=>{});}catch{} });
$('#btnCancel').addEventListener('click', closeModal);

function syncFormFromQuick(){
  $('#formA').value = $('#quickA').value;
  fillB($('#formB'), $('#formA').value);
  $('#formB').value = $('#quickB').value;

  $('#formH').value = +$('#dH').value||0;
  $('#formM').value = +$('#dM').value||0;
  $('#formS').value = +$('#dS').value||0;
  $('#formLane').value = +$('#lane').value||1;
  $('#formLead').value = +$('#leadMin').value||0;
}
$('#btnAdd').addEventListener('click', ()=>{
  const data = {
    a: $('#formA').value,
    b: $('#formB').value,
    h: +$('#formH').value||0,
    m: +$('#formM').value||0,
    s: +$('#formS').value||0,
    lane: +$('#formLane').value||1,
    lead: +$('#formLead').value||0,
    color: randomColor() // 表單新增也給隨機顏色
  };
  if((data.h+data.m+data.s)===0){ alert('重生時間不可為 0'); return; }
  addTimer(data);
  // 同步回快速區
  $('#quickA').value = data.a; fillB($('#quickB'), data.a); $('#quickB').value = data.b;
  $('#dH').value=data.h; $('#dM').value=data.m; $('#dS').value=data.s;
  $('#lane').value=data.lane; $('#leadMin').value=data.lead;
  saveFormState();
  closeModal();
});

/* A 變動 → B 重建（快速區與表單區） */
function hookCascade(aSel, bSel){
  aSel.addEventListener('change', ()=>{
    fillB(bSel, aSel.value);
    saveFormState();
  });
}
hookCascade($('#quickA'), $('#quickB'));
hookCascade($('#formA'),  $('#formB'));

/* 快速區按鈕 */
document.getElementById('btnQuickAdd').addEventListener('click', quickAdd);

/* 快速欄位更動 → 存 Cookie */
['#quickA','#quickB','#dH','#dM','#dS','#lane','#leadMin'].forEach(s=>{
  $(s).addEventListener('change', saveFormState);
  $(s).addEventListener('input', saveFormState);
});

/* 清空 */
$('#btnClear').addEventListener('click', ()=>{
  if(confirm('確定要刪除所有計時？')){ timers = []; save(); render(); }
});

/* -------------------- 啟動 -------------------- */
function boot(){
  fillA($('#quickA')); fillB($('#quickB'), A_OPTIONS[0]);
  fillA($('#formA'));  fillB($('#formB'), A_OPTIONS[0]);

  ['quickA','quickB','formA','formB'].forEach(id=>{
    const el = document.getElementById(id);
    el && el.addEventListener('change', ()=>{ el.blur && el.blur(); });
  });

  updateLaneSwatch(); // 顯示第一次的分流顏色
  loadFormState(); load(); render();
}
boot();
</script>
</body>
<footer style="margin:40px auto; padding:20px; text-align:center; font-size:13px; color:var(--muted)">
  <div style="margin-bottom:8px">
    訪客計數器：
    <a href="https://cn.web-counter.net" title="網站訪問計數">
      <img src="https://www.web-counter.net/count_20091204.php?c=1fuYlQ1R9xV" 
            style="border:0;padding:0;margin:0;" 
            alt="網站訪問計數" />
    </a>
  </div>
  <div>
    本工具由 <a href="https://could562073.github.io" target="_blank" rel="noopener">Jun Rong Chen</a> 製作。
  </div>
  <div>
    本計時器為玩家自製之非官方工具，僅供個人娛樂使用，請勿用於商業用途。
  </div>
</footer>

</html>
