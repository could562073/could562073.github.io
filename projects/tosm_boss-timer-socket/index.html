<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>æ•‘ä¸–è€…ä¹‹æ¨¹ m - é‡å¤–Bossè¨ˆæ™‚å™¨(å°Šçˆµé€£ç·šç‰ˆ)</title>
<link rel="icon" href="https://could562073.github.io/projects/tosm_boss-timer/favicon.ico" type="image/x-icon">
<style>

  /* --- Inline toggle switch --- */
  .toggle{display:inline-flex; align-items:center; gap:10px; user-select:none;}
  .toggle-input{position:absolute; opacity:0; width:0; height:0;}
  .toggle-track{position:relative; width:46px; height:26px; border-radius:999px; background:rgba(255,255,255,.14); display:inline-block; vertical-align:middle; transition:.2s background, .2s box-shadow;}
  .toggle-track .knob{position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:50%; background:#fff; transition:.2s left, .2s transform; box-shadow:0 2px 8px rgba(0,0,0,.25);}
  .toggle-input:checked + .toggle-track{ background: var(--ok, #34d399); }
  .toggle-input:checked + .toggle-track .knob{ left:23px; }
  .toggle-text{font-weight:600; letter-spacing:.2px;}



  

  :root{
    --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --brand:#22d3ee; --accent:#a78bfa; --ok:#34d399; --warn:#f59e0b; --danger:#ef4444;
    --card:#0b1220; --ring:rgba(34,211,238,.4); --shadow:0 10px 30px rgba(0,0,0,.35);
    font-synthesis-weight:none;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 600px at 20% -10%, rgba(167,139,250,.14), transparent 60%),
                radial-gradient(900px 500px at 110% 20%, rgba(34,211,238,.12), transparent 60%),
                var(--bg);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Microsoft JhengHei", "Noto Sans TC", Arial, "PingFang TC", sans-serif;
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{max-width:1200px; margin:28px auto; padding:0 20px;}
  header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; justify-content:space-between; gap:16px;
    margin-bottom:14px; padding:12px 0;
    background:linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,0));
    backdrop-filter:saturate(120%) blur(2px);
  }
  h1{font-size:clamp(18px,2.6vw,28px); margin:0; letter-spacing:.5px}
  .now{font-variant-numeric:tabular-nums; color:var(--muted); font-size:13px}

  .grid{display:grid; gap:18px; grid-template-columns: 380px 1fr;}
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), var(--panel);
    border:1px solid rgba(255,255,255,.06);
    border-radius:18px; padding:18px; box-shadow:var(--shadow);
  }

  /* å·¦å´ */
  .meta{display:grid; gap:14px}
  .kv{display:grid; gap:8px}
  .kv label{font-size:13px; color:var(--muted)}

  .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
  /* å¿«é€Ÿæ–°å¢æ”¹ç‚ºå–®æ¬„ç›´æ’ï¼ˆæ¡Œæ©Ÿä¹Ÿä¸€è‡´ï¼‰ */
  .row.row3{ display:grid; grid-template-columns:1fr; gap:10px; }

  .laneWrap{display:flex; align-items:center; gap:6px;}
  .laneWrap .input{
    width:84px;
    height:32px;
    padding:0 10px;
    text-align:center;
    line-height:32px;
    font-size:16px;
  }
  .swatch{
    width:28px; height:28px; border-radius:8px; border:1px solid rgba(255,255,255,.2);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.2);
  }

  .triple{display:grid; grid-template-columns: repeat(3,1fr); gap:10px;}
  .input, select{
    width:100%; padding:12px 12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.08);
    background:var(--card); color:var(--text);
    outline:none; transition: .15s border, .15s box-shadow, .15s transform;
    font-size:15px;
    min-width:0;
  }
  /* ç§»é™¤æ•¸å­—è¼¸å…¥çš„ä¸Šä¸‹ç®­é ­ï¼Œé¿å…æ“ å£“èˆ‡é«˜åº¦ä¸ä¸€è‡´ */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number]{ -moz-appearance: textfield; }

  .laneBtn{
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,.2);
    background: var(--card);
    color: var(--text);
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: .15s filter, .15s transform;
  }
  .laneBtn:hover { filter: brightness(1.1); }
  .laneBtn:active { transform: translateY(1px); }

  select{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .input:focus, select:focus{
    border-color:var(--brand); box-shadow:0 0 0 4px var(--ring);
    font-variant-numeric: tabular-nums;
  }

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
    background: linear-gradient(180deg, rgba(34,211,238,.22), rgba(34,211,238,.12));
    color:#052026; font-weight:600; letter-spacing:.3px; cursor:pointer;
    transition: .15s transform, .15s filter, .15s box-shadow; box-shadow:var(--shadow);
    touch-action:manipulation;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn-outline{background:transparent; color:var(--brand); border-color:rgba(34,211,238,.35)}
  .btn-row{display:flex; gap:10px; flex-wrap:wrap}
  /* é¡¯ç¤ºåœ¨å³ä¸Šè§’çš„ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• */
  .tbtn{
    -webkit-appearance:none; appearance:none; border:none; outline:none;
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 16px; border-radius:999px;
    background: rgba(255,255,255,.06);
    color: var(--text);
    border: 1px solid rgba(255,255,255,.24);
    box-shadow: var(--shadow);
    cursor:pointer; user-select:none;
    transition: .15s transform, .15s filter, .15s box-shadow, .15s background-color, .15s border-color;
    font-weight:600; letter-spacing:.2px;
    line-height:1;
  }
  .tbtn:hover{ filter: brightness(1.08); }
  .tbtn:active{ transform: translateY(1px); }
  .tbtn:focus-visible{ box-shadow: 0 0 0 4px var(--ring); }

  /* æ·ºè‰²ä¸»é¡Œä¸‹çš„æ¨£å¼ */
  body.light .tbtn{
    background: #ffffff;
    color: #0f172a;
    border-color: rgba(0,0,0,.15);
    box-shadow: 0 8px 18px rgba(15,23,42,.08);
  }
  body.light .tbtn:hover{ filter: none; box-shadow: 0 10px 22px rgba(15,23,42,.10); }


  /* è®“ã€Œç«‹å³æ–°å¢ã€æ›´é†’ç›® */
  #btnQuickAdd{
    background: rgba(34,211,238,.14);
    color: #e6fbff;
    border: 1px solid rgba(34,211,238,.45);
    border-radius: 12px;
    padding: 12px 18px;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: .2px;
    box-shadow: var(--shadow);
    transition: .15s transform, .15s filter, .15s box-shadow;
  }
  #btnQuickAdd:hover{ filter: brightness(1.06); }
  #btnQuickAdd:active{ transform: translateY(1px); }
  

  .hint{font-size:12px; color:var(--muted); margin-top:4px}

  /* å³å´æ¸…å–® */
  .list{display:grid; gap:14px;}
  .card{
    position:relative; display:grid; gap:6px;
    padding:14px 16px; border-radius:14px;
    background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 50%), var(--card);
    border:1px solid rgba(255,255,255,.06);
  }
  .row2{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .count{font-variant-numeric:tabular-nums; font-size:18px; letter-spacing:.5px}
  .soon .count{ color:var(--warn)}
  .expired .count{ color:var(--danger)}

  /* ä¸‰æ®µå¼æ¨™é¡Œåˆ— */
  .title{
    display:flex; align-items:center; gap:10px; min-width:0;
  }
  .labelGroup{display:flex; gap:6px; align-items:center; flex:0 0 auto;}
  .bossName{
    flex:1 1 auto; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    font-weight:700; letter-spacing:.2px;
  }

  .badge{
    display:inline-flex; align-items:center;
    font-size:12px; padding:4px 10px; border-radius:999px;
    background:rgba(167,139,250,.15); color:var(--accent);
    border:1px solid rgba(167,139,250,.35)
  }
  /* åˆ†æµè† å›Šï¼ˆèˆ‡ä¸»æŒ‰éˆ•ä¸€è‡´çš„è† å›Šè¦–è¦ºï¼‰ */
  .badge-lane{
    border:none;
    font-weight:700;
    letter-spacing:.2px;
    padding:6px 12px;
    border-radius:999px;
    background: var(--card-accent);
    color:#fff;
  }
  body.light .badge-lane{
    border:none;
    font-weight:700;
    letter-spacing:.2px;
    padding:6px 12px;
    border-radius:999px;
    background: var(--card-accent);
    color:#fff;
  }


  /* Episode æ¨™ç±¤é¡è‰²ï¼ˆåè‰²ï¼‰ */
  .badge-ep1 { background: rgba(239,68,68,.15);  color:#ef4444; border-color:rgba(239,68,68,.35);}
  .badge-ep2 { background: rgba(245,158,11,.15); color:#f59e0b; border-color:rgba(245,158,11,.35);}
  .badge-ep3 { background: rgba(132,204,22,.15); color:#84cc16; border-color:rgba(132,204,22,.35);}
  .badge-ep4 { background: rgba(34,197,94,.15);  color:#22c55e; border-color:rgba(34,197,94,.35);}
  .badge-ep5 { background: rgba(16,185,129,.15); color:#10b981; border-color:rgba(16,185,129,.35);}
  .badge-ep6 { background: rgba(6,182,212,.15);  color:#06b6d4; border-color:rgba(6,182,212,.35);}
  .badge-ep7 { background: rgba(59,130,246,.15); color:#3b82f6; border-color:rgba(59,130,246,.35);}
  .badge-ep8 { background: rgba(139,92,246,.15); color:#8b5cf6; border-color:rgba(139,92,246,.35);}
  .badge-ep9 { background: rgba(236,72,153,.15); color:#ec4899; border-color:rgba(236,72,153,.35);}
  .badge-ep10{ background: rgba(107,114,128,.15); color:#6b7280; border-color:rgba(107,114,128,.35);}

  /* Lv. xx æ¨™ç±¤ï¼ˆåšæˆå’Œåˆ†æµä¸€æ¨£çš„è† å›Šæ„Ÿï¼Œé¸ç”¨æŸ”å’Œè—ç¶ ç³»ï¼‰ */
  .badge-lv{
    background: rgba(2,132,199,.18);
    color:#075985;
    border:1px solid rgba(2,132,199,.35);
  }
  /* åˆ†æµ badge çµ±ä¸€æ¨£å¼ï¼šä½¿ç”¨æ¼¸å±¤ï¼Œæ›´ç¬¦åˆæ•´é«”è¨­è¨ˆ */
  .badge-lane{
    border:none;
    font-weight:700;
    letter-spacing:.2px;
    padding:6px 12px;
    border-radius:999px;
    background: var(--card-accent);
    color:#fff;
  }
  body.light .badge-lane{
    border:none;
    font-weight:700;
    letter-spacing:.2px;
    padding:6px 12px;
    border-radius:999px;
    background: var(--card-accent);
    color:#fff;
  }

  /* === Dark mode readability upgrades for badges === */
  body:not(.light) .badge{
    font-weight:700;
    letter-spacing:.2px;
    padding:5px 12px;
    border-width:1px;
    
    box-shadow: inset 0 -1px 0 rgba(255,255,255,.04);
  }
  /* Episode colors â€” stronger background/contrast in dark mode */
  body:not(.light) .badge-ep1  { background: rgba(239,68,68,.28);  color:#fecaca; border-color:rgba(239,68,68,.55); }
  body:not(.light) .badge-ep2  { background: rgba(245,158,11,.28); color:#fde68a; border-color:rgba(245,158,11,.55); }
  body:not(.light) .badge-ep3  { background: rgba(132,204,22,.28); color:#d9f99d; border-color:rgba(132,204,22,.55); }
  body:not(.light) .badge-ep4  { background: rgba(34,197,94,.28);  color:#bbf7d0; border-color:rgba(34,197,94,.55);  }
  body:not(.light) .badge-ep5  { background: rgba(16,185,129,.28); color:#a7f3d0; border-color:rgba(16,185,129,.55); }
  body:not(.light) .badge-ep6  { background: rgba(6,182,212,.28);  color:#a5f3fc; border-color:rgba(6,182,212,.55); }
  body:not(.light) .badge-ep7  { background: rgba(59,130,246,.28); color:#bfdbfe; border-color:rgba(59,130,246,.55); }
  body:not(.light) .badge-ep8  { background: rgba(139,92,246,.28); color:#ddd6fe; border-color:rgba(139,92,246,.55); }
  body:not(.light) .badge-ep9  { background: rgba(236,72,153,.28); color:#fbcfe8; border-color:rgba(236,72,153,.55); }
  body:not(.light) .badge-ep10 { background: rgba(107,114,128,.32); color:#e5e7eb; border-color:rgba(107,114,128,.6); }

  /* Level badge â€” clearer teal in dark mode */
  body:not(.light) .badge-lv{
    background: rgba(14,165,233,.28);
    color:#e0f2fe;
    border-color: rgba(14,165,233,.55);
    
  }


  .tools{display:flex; gap:8px}
  .iconbtn{
    width:36px; height:36px; display:inline-grid; place-items:center; border-radius:10px;
    border:1px solid rgba(255,255,255,.08); background:transparent; color:var(--muted);
    cursor:pointer; touch-action:manipulation;
  }
  .iconbtn:hover{color:#fff; border-color:rgba(255,255,255,.24)}
  .empty{text-align:center; color:var(--muted); padding:24px 8px; border:1px dashed rgba(255,255,255,.12); border-radius:14px}

  /* RWD */
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  @media (max-width:640px){
    .wrap{padding:0 14px}
    .panel{padding:14px; border-radius:16px}
    .row{grid-template-columns:1fr; gap:8px}
    .row.row3{ grid-template-columns:1fr; }
    .triple{grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px}
    .btn{width:100%}
    .btn-row{flex-direction:column}
    .iconbtn{width:40px; height:40px}
    .count{font-size:20px}
  }

  /* â€”â€” æ·ºè‰²ä¸»é¡Œï¼šè¦†å¯«è®Šæ•¸ â€”â€” */
  body.light{
    --bg:#f5f7fb; --panel:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
    --ring:rgba(2,132,199,.25); --shadow:0 10px 30px rgba(15,23,42,.08);
  }
  body.light header{
    background:linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,0));
    backdrop-filter:saturate(120%) blur(4px);
  }
  body.light .panel, body.light .card{ border-color: rgba(15,23,42,.08); }
  body.light .empty{ border-color: rgba(15,23,42,.12); color:#64748b; }
  body.light .input, body.light select { border-color: rgba(0,0,0,.15); background:#fff; color:#000; }
  body.light .iconbtn { border-color: rgba(0,0,0,.15); color:#6b7280; background:transparent; }
  body.light .iconbtn:hover { border-color: rgba(0,0,0,.35); color:#000; }
  body.light .input:focus, body.light select:focus { border-color:#0284c7; box-shadow:0 0 0 3px rgba(2,132,199,.25); }

  button{font:inherit;}
  .iconbtn{-webkit-appearance:none; appearance:none; background:transparent; outline:none; line-height:1;}
  body:not(.light) .iconbtn.danger{ border-color: rgba(255,255,255,.14); color: var(--muted); }
  .iconbtn.danger:hover{ filter: brightness(1.1); }

  /* å¡ç‰‡é¡è‰²è®Šæ•¸ï¼ˆç”± JS æ³¨å…¥ï¼‰ */
  .card {
    --card-accent: #22d3ee;
    --card-tint: rgba(34,211,238,.08);
    border-width: 2px;
    border-color: rgba(255,255,255,.06);
    background:
      linear-gradient(180deg, rgba(255,255,255,.03), transparent 50%),
      var(--card);
    position: relative;
    overflow: hidden;
  }
  .card::before{
    content:"";
    position:absolute; left:0; top:0; bottom:0; width:6px;
    border-radius:12px 0 0 12px;
    background: var(--card-accent);
    opacity:.9;
  }
  .card.colored {
    border-color: var(--card-accent);
    box-shadow: 0 6px 22px rgba(0,0,0,.28);
  }
  .card.colored .title,
  .card.colored .count,
  .card.colored .small{ position: relative;
    overflow: hidden; }
  .card.colored::after{
    content:"";
    position:absolute; inset:0; border-radius:12px;
    background: var(--card-tint);
    pointer-events:none;
  }
  body.light .card.colored{ box-shadow: 0 6px 18px rgba(2,132,199,.08); }
  body.light .card::before{
    content:"";
    position:absolute; left:0; top:0; bottom:0; width:6px;
    border-radius:12px 0 0 12px;
    background: var(--card-accent);
    opacity:.9;
  }

  /* æ·ºè‰²ä¸»é¡Œä¸‹çš„ã€Œç«‹å³æ–°å¢ã€æŒ‰éˆ•ï¼šæé«˜å°æ¯” */
  body.light #btnQuickAdd{
    background: rgba(2,132,199,.10);
    color: #0f172a;
    border-color: rgba(2,132,199,.35);
    box-shadow: 0 8px 18px rgba(15,23,42,.08);
  }
  body.light #btnQuickAdd:hover{ filter:none; box-shadow: 0 10px 22px rgba(15,23,42,.10); }


  /* æ·ºè‰²ä¸»é¡Œä¸‹çš„åˆ†æµ +/- æŒ‰éˆ•é‚Šæ¡†èˆ‡åº•è‰²ï¼ˆå¯è¦‹åº¦æå‡ï¼‰ */
  body.light .laneBtn{
    border-color: rgba(0,0,0,.18);
    background: #ffffff;
    color: #0f172a;
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
  }
  body.light .laneBtn:hover{ filter:none; background:#f8fafc; border-color: rgba(0,0,0,.28); }
  body.light .laneBtn:active{ transform: translateY(1px); }


  /* æ·ºè‰²ä¸»é¡Œä¸‹çš„åˆ†æµè¼¸å…¥æ¡†é‚Šæ¡†åŠ å¼·ï¼Œèˆ‡ +/- è¦–è¦ºä¸€è‡´ */
  body.light .laneWrap .input{
    border-color: rgba(0,0,0,.18);
    background: #ffffff;
    color: #0f172a;
  }
  body.light .laneWrap .input:hover{ border-color: rgba(0,0,0,.22); }


/* === Boss éšæ®µåœ“å½¢æŒ‰éˆ• === */
.stage-buttons {
  display: flex;
  gap: 6px;
  margin-top: 6px;
}
.stage-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid var(--danger);
  background: transparent;
  color: var(--danger);
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all .2s;
  line-height: 1;
}
.stage-btn:hover { filter: brightness(1.05); }
.stage-btn.active {
  background: var(--danger);
  color: #fff;
  border-color: var(--danger);
}


  /* éšæ®µå¾½ç« ï¼ˆç´…è‰²ï¼‰ */
  .badge-stage{
    background: rgba(239,68,68,.15);
    color:#ef4444;
    border:1px solid rgba(239,68,68,.35);
  }
  body:not(.light) .badge-stage{
    background: rgba(239,68,68,.28);
    color:#fecaca;
    border-color: rgba(239,68,68,.55);
  }

</style>
</head>
<body>


  <div class="wrap">
    <header>
      <h1>æ•‘ä¸–è€…ä¹‹æ¨¹ m - é‡å¤–Bossè¨ˆæ™‚å™¨(å°Šçˆµé€£ç·šç‰ˆ)</h1>
      <div style="display:flex; align-items:center; gap:10px;">
        <button id="themeToggle" class="tbtn" type="button" aria-pressed="false" title="åˆ‡æ›ä¸»é¡Œ">â˜€ï¸ æ—¥é–“</button>
        <div class="now" id="now">â€”</div>
      </div>
    </header>

    <div class="grid">
      <!-- å·¦é‚Šï¼šæ“ä½œ/èªªæ˜ -->
      <section class="panel">
        <div class="meta">

          <div class="kv">
            <label>å¿«é€Ÿæ–°å¢</label>
            <div class="row row3">
              <select id="quickA" class="input" title="ä¸»åˆ†é¡ (A)"></select>
              <select id="quickB" class="input" title="æ¬¡åˆ†é¡ (B)"></select>
              <div class="laneWrap">
                <span>åˆ†æµ: </span>
                <button type="button" class="laneBtn" id="laneDec">âˆ’</button>
                <input id="lane" class="input" type="number" min="1" value="1" title="åˆ†æµ">
                <button type="button" class="laneBtn" id="laneInc">+</button>
                <span id="laneSwatch" class="swatch" title="æ­¤æ¬¡åˆ†æµé¡è‰²"></span>
              </div>
            </div>
          </div>

          <div class="kv">
            <label>é è¨­é‡ç”Ÿæ™‚é–“ (å°æ™‚/åˆ†/ç§’)</label>
            <div class="triple">
              <input id="dH" class="input" type="number" min="0" value="0" />
              <input id="dM" class="input" type="number" min="0" value="5" />
              <input id="dS" class="input" type="number" min="0" value="0" />
            </div>
            <div class="hint">æ­¤å€åªå½±éŸ¿ã€Œå¿«é€Ÿæ–°å¢ã€ï¼ŒçœŸæ­£çš„å€’æ•¸ä»¥æ¯å€‹é …ç›®å»ºç«‹æ™‚çš„è¨­å®šç‚ºæº–ã€‚</div>
          </div>

          <div class="row">
            <div class="kv" style="grid-column:1/-1">
              <label>æé†’æ™‚é–“ (åˆ†)</label>
              <input id="leadMin" class="input" type="number" min="0" value="0" />
            </div>
          </div>

          <div class="kv">
            <div class="btn-row">
              <button id="btnQuickAdd" class="btn" type="button">â• ç«‹å³æ–°å¢</button>
            </div>
            <div class="hint">ä½¿ç”¨ä¸Šæ–¹æ¬„ä½è¨­å®šä¸¦æŒ‰ã€Œç«‹å³æ–°å¢ã€ã€‚</div>
          
          <div class="kv">
            <div class="row" style="grid-template-columns:1fr;">
              <label class="toggle" for="soundToggleInput" title="åˆ‡æ›æç¤ºéŸ³">
                <input id="soundToggleInput" class="toggle-input" type="checkbox" />
                <span class="toggle-track" aria-hidden="true"><span class="knob"></span></span>
                <span class="toggle-text">æç¤ºéŸ³</span>
                <span id="soundStateText" class="small">é–‹</span>
              </label>
            </div>
          </div>

          <div class="kv">
            <button id="btnClear" class="btn btn-outline" type="button">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è¨ˆæ™‚</button>
            <div class="hint">æ‰€æœ‰è³‡æ–™é›²ç«¯åŒæ­¥ï¼ˆå¤šäººå…±ç”¨ã€å³æ™‚æ›´æ–°ï¼‰ã€‚</div>
          </div>
        </div>
      </section>

      <!-- å³é‚Šï¼šæ¸…å–® -->
      <section class="panel">
        <div id="list" class="list"></div>
        <div id="empty" class="empty" style="display:none">ç›®å‰æ²’æœ‰è¨ˆæ™‚ï¼Œé»å·¦é‚Šã€Œç«‹å³æ–°å¢ã€é–‹å§‹å§ï¼</div>
      </section>
    </div>

    <footer style="margin:40px auto; padding:20px; text-align:center; font-size:13px; color:var(--muted)">
      <div>æœ¬è¨ˆæ™‚å™¨ç‚ºç©å®¶è‡ªè£½ä¹‹éå®˜æ–¹å·¥å…·ï¼Œåƒ…ä¾›å€‹äººå¨›æ¨‚ä½¿ç”¨ï¼Œè«‹å‹¿ç”¨æ–¼å•†æ¥­ç”¨é€”ã€‚</div>
      <div>æœ¬å·¥å…·ä¸ä¿è­‰æ­£ç¢ºæ€§èˆ‡å³æ™‚æ€§ï¼Œä½¿ç”¨é¢¨éšªè«‹ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ“”ã€‚</div>
      <div style="margin-top:8px">
        ç¶²ç«™è¨ªå•è¨ˆæ•¸ï¼š
        <a href="https://cn.web-counter.net" title="ç¶²ç«™è¨ªå•è¨ˆæ•¸">
          <img src="https://www.web-counter.net/count_20091204.php?c=1fuYlQ1R9xV" style="border:0;padding:0;margin:0;" alt="ç¶²ç«™è¨ªå•è¨ˆæ•¸" />
        </a>
        <div style="position:fixed; right:10px; bottom:5px; font-size:12px; color:#aaa;">
        v1.0.0 Release
        </div>
      </div>
      
    </footer>
  </div>

  <!-- ä½¿ç”¨å¤–éƒ¨ mp3 éŸ³æ•ˆ -->
  <audio id="beep" preload="auto">
    <source src="https://could562073.github.io/projects/tosm_boss-timer/sound28.mp3" type="audio/mp3">
  </audio>

<script>
/* ========== åˆ†æµåŠ æ¸›æŒ‰éˆ• ========== */
const laneInput = document.getElementById('lane');
document.getElementById('laneInc').addEventListener('click', () => {
  laneInput.value = Number(laneInput.value || 1) + 1;
  laneInput.dispatchEvent(new Event('change'));
});
document.getElementById('laneDec').addEventListener('click', () => {
  const minVal = Number(laneInput.min || 1);
  let v = Number(laneInput.value || 1) - 1;
  if (v < minVal) v = minVal;
  laneInput.value = v;
  laneInput.dispatchEvent(new Event('change'));
});

/* hexToRgba */
function hexToRgba(hex, alpha=0.1){
  const c = hex.replace('#','');
  const r = parseInt(c.slice(0,2),16);
  const g = parseInt(c.slice(2,4),16);
  const b = parseInt(c.slice(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

/* ===== ä¸»é¡Œåˆ‡æ›ï¼šæ·±/æ·ºè‰² ===== */
const THEME_KEY = 'theme';
function applyTheme(theme){
  if(theme === 'light'){ document.body.classList.add('light'); }
  else{ document.body.classList.remove('light'); theme = 'dark'; }
  localStorage.setItem(THEME_KEY, theme);
  updateThemeToggleUI();
}
function updateThemeToggleUI(){
  const btn = document.getElementById('themeToggle');
  if(!btn) return;
  const isLight = document.body.classList.contains('light');
  btn.textContent = isLight ? 'ğŸŒ™ å¤œé–“' : 'â˜€ï¸ æ—¥é–“';
  btn.setAttribute('aria-pressed', String(isLight));
  btn.title = isLight ? 'åˆ‡æ›åˆ°æ·±è‰²æ¨¡å¼' : 'åˆ‡æ›åˆ°æ·ºè‰²æ¨¡å¼';
}
(function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  const sysLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
  applyTheme(saved || (sysLight ? 'light' : 'dark'));
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'themeToggle'){
      const isLight = document.body.classList.contains('light');
      applyTheme(isLight ? 'dark' : 'light');
    }
  });
})();

/* -------------------- LocalStorage -------------------- */
const LS_TIMERS = "bossTimers_v1";
const LS_FORM   = "bossForm_v1";
function lsSet(key, value){ localStorage.setItem(key, value); }
function lsGet(key){ return localStorage.getItem(key) || ""; }

/* -------------------- è³‡æ–™æ¨¡å‹ -------------------- */
let timers = []; // {id, a, b, lane, laneColor, durationMs, leadMin, startAt, alert1Fired, alert2Fired}
const $ = s => document.querySelector(s);
const listEl = $('#list');
const emptyEl = $('#empty');
const beepEl = $('#beep');

/* -------------------- ä¸»/æ¬¡é¸å–®è³‡æ–™ -------------------- */
const B_DICT = {
  "Episode 1": [
    "å¤å¥§é›·ä¼Šæ±é‚Šæ£®æ— Lv.3 - ç“¦å¡éº—æ¶…å¥³ç¥åƒ",
    "è“®å¸•æ‹‰æ²™æ± å¡˜ Lv.5 - ä¸ç¥¥çš„ æ¬¡å…ƒè£‚ç¸«",
    "å¤å¥§é›·ç¤¦å±±æ‘èŠ Lv.7 - å‘åŠ£çš„ èµ¤ç´…å¸ƒè²é–€å£«",
    "æ°´æ™¶ç¤¦å±± Lv.9 - å¼·éŸŒçš„ æƒ¡éˆå›ä¸»",
  ],
  "Episode 2": [
    "æ–¯æ‹‰å±‹å¡”æ–¯å³½è°· Lv.10 -ç“¦å¡éº—æ¶…å¥³ç¥åƒ",
    "å‡±åˆ©é«˜åŸ Lv.11 - ä¸ç¥¥çš„ æ¬¡å…ƒè£‚ç¸«",
    "å¥ˆæ™®é‡Œå¡”æ–¯æ‡¸å´– Lv.12 - å¼·éŸŒçš„ ç‹åº§å¤§èœ˜è››",
    "æ³°å…§èŠ±åœ’ Lv.13 - å¼·éŸŒçš„ è±¬ç± è‰",
    "æ³°å…§è–å ‚åœ°ä¸‹1å±¤ Lv.15 - å‘åŠ£çš„ ç¨çœ¼å·¨äºº",
    "æ³°å…§è–å ‚åœ°ä¸Š1å±¤ Lv.17 - å¼·éŸŒçš„ ç‘ªçˆ¾é›·é£›é¾",
    "æ³°å…§è–å ‚åœ°ä¸Š2å±¤ Lv.19 - å¼·éŸŒçš„ åœ°ç„äº¡éˆ"
  ],
  "Episode 3": [
    "åº«é­¯æ£®æ— Lv.20 - ç“¦å¡éº—æ¶…å¥³ç¥åƒ",
    "å…‹å°¼å¤šæ–¯æ£®æ— Lv.21 - ä¸ç¥¥çš„ æ¬¡å…ƒè£‚ç¸«",
    "é”æ—¦æ£®æ— Lv.22 - å¼·éŸŒçš„ ä¼Šå ¤æ–¯å¤§å˜´ç¸",
    "è«¾å·´å“ˆå…¬æœƒæ‰€ Lv.24 - å‘åŠ£çš„ æœ¨ä¹ƒä¼Šè³½è¥¿ç‰¹",
    "è«¾å·´å“ˆåˆ¥é¤¨ Lv.26 - å¼·éŸŒçš„ ç¶­å°¼äºçŒ´å­",
    "è«¾å·´å“ˆæœ¬é™¢ Lv.28 - æ†¤æ€’çš„ æ­»äº¡é­”å¥³"
  ],
  "Episode 4": [
    "è²é›…å±±è°· Lv.30 - ç“¦å¡éº—æ¶…å¥³ç¥åƒ",
    "æ¯”çˆ¾å¡”æºªè°· Lv.31 - ä¸ç¥¥çš„ æ¬¡å…ƒè£‚ç¸«",
    "ç§‘åšçˆ¾ç‰¹æ£®æ— Lv.32 - å‘åŠ£çš„ å¥³å¦–å…‹èŠé»˜",
    "è³½æå°¼å±±æº Lv.34 - å¼·éŸŒçš„ é­”æ–¯æ€ª",
    "åŸ¹çˆ¾å…‹ç¥æ®¿ Lv.36 - å¼·éŸŒçš„ æ¯’é­”è›™åœ–åœ–",
    "å®‰æ£®å¡”å†°æºåœ° Lv.38 - æ†¤æ€’çš„ æ°´è›­"
  ],
  "Episode 5": [
    "å¡è˜¿åˆ©æ–¯æ³‰æ°´ Lv.40 - ç“¦å¡éº—æ¶…å¥³ç¥åƒ",
    "èŠå¡”æ–¯å°æºª Lv.42 - ä¸ç¥¥çš„ æ¬¡å…ƒè£‚ç¸«",
    "å¾·æ…•çˆ¾ä½ƒè¾²æ‘ Lv.44 - å‘åŠ£çš„ åœ°å¿ƒèŸ²ç‹",
    "å¾·æ…•çˆ¾èŠåœ’ Lv.46 - å¼·éŸŒçš„ å…‹èŠç°æ€ª",
    "å¾·æ…•çˆ¾å¤–åŸ Lv.48 - æ†¤æ€’çš„ èµ¤ç´…é›·ç­æ‰ç‰¹"
  ],
  "Episode 6": [
    "é”ä¼Šç´é¤Šèœ‚åœ° Lv.50 - ç“¦å¡éº—æ¶…å¥³ç¥åƒ",
    "æ¯”çˆ¾é‚£æ£®æ— Lv.51 - ä¸ç¥¥çš„ æ¬¡å…ƒè£‚ç¸«",
    "çƒå¥‡æ–¯è€•è€˜ä½œåœ° Lv.52 - å¼·éŸŒçš„ å¥§ç‘ªå¡”æ–¯",
    "æ˜¥å…‰æ¨¹æ— Lv.53 - å‘åŠ£çš„ å­Ÿæè‚¯",
    "é—œå£è·¯ Lv.55 - å¼·éŸŒçš„ åˆ‡æ³¢å‹’",
    "å²çˆ¾ç‰¹å‡±æ‹‰æ£®æ— Lv.57 - å¼·éŸŒçš„ äºå´‘",
    "å…‹å·´ä¼Šæ‹‰æ–¯æ£®æ— Lv.59 - æ†¤æ€’çš„ ä½›è˜­æ™®",
  ],
  "Episode 7": [
    "é­¯å¡æ–¯é«˜åŸ Lv.60 - ç“¦å¡éº—æ¶…å¥³ç¥åƒ",
    "ç‹ä¹‹é«˜åŸ Lv.61 - ä¸ç¥¥çš„ æ¬¡å…ƒè£‚ç¸«",
    "æœ­å¡é‡Œè€¶è€¶çˆ¾äº¤å‰è·¯ Lv.62 - å‘åŠ£çš„ è²äºå¡æ‹‰æ–¯",
    "ç‹é™µ1å±¤ Lv.64 - å¼·éŸŒçš„ å¢“ä¸»æ´›å¾·",
    "ç‹é™µ2å±¤ Lv.66 - å¼·éŸŒçš„ åº«å‹’å¡æ–¯",
    "ç‹é™µ3å±¤ Lv.68 - æ†¤æ€’çš„ é›·å…‹è¥¿æ³¢"
  ],
  "Episode 8": [
    "é˜¿é›·é­¯è«¾ç”·çˆµé ˜ Lv.70 - å‘åŠ£çš„ å·¨é­”è ",
    "æ°´è·¯æ©‹åœ°å€ Lv.70 - å¼·éŸŒçš„ å…‹æ´›æå¾·",
    "é­”æ—æ”¶ç›£æ‰€ç¬¬1å€ Lv.71 - å¼·éŸŒçš„ å¸ƒçˆ¾é­¯",
    "é­”æ—æ”¶ç›£æ‰€ç¬¬3å€ Lv.72 - å‘åŠ£çš„ åŠªäºè€¶é›·",
    "é­”æ—æ”¶ç›£æ‰€ç¬¬4å€ Lv.73 - å¼·éŸŒçš„ è¿ªæ­å°¼æ–¯",
    "é­”æ—æ”¶ç›£æ‰€ç¬¬5å€ Lv.74 - æ†¤æ€’çš„ å“ˆå‹ƒå…‹"
  ],
  "Episode 9": [
    "å¥³ç¥çš„å¤é™¢ Lv.75 - å¼·éŸŒçš„ æ­»éˆæŸ¥æ™®åˆ©",
    "ä½©è¿ªç±³å®‰å¤–åŸ Lv.76 - å‘åŠ£çš„ æƒ¡é­”è‘›æ´›å¤«",
    "é­”æ³•å¸«ä¹‹å¡”1å±¤ Lv.77 - å¼·éŸŒçš„ ç«ç„°èœ¥èœ´ç‹",
    "é­”æ³•å¸«ä¹‹å¡”2å±¤ Lv.78 - å¼·éŸŒçš„ ç‘ªå› æ´›å¾·",
    "é­”æ³•å¸«ä¹‹å¡”3å±¤ Lv.79 - æ†¤æ€’çš„ èµ«å˜‰å¡éœ²å¥³å¦–"
  ],
  "Episode 10": [
    "å¤§æ•™å ‚æ‡ºæ‚”è·¯ Lv.80 - å‘åŠ£çš„ å–€æ‹‰åº«æ›¼",
    "å¤§æ•™å ‚æ­£æ®¿ Lv.81 - å¼·éŸŒçš„ ç«ç„°æ¬Šæ–",
    "å¤§æ•™å ‚å¤§è¿´å»Š Lv.82 - å¼·éŸŒçš„ åˆ©æ³°åŠ›æ–¯",
    "å¤§æ•™å ‚è‡³è–æ‰€ Lv.83 - æ†¤æ€’çš„ é‚£æŸ¯ææ–¯"
  ]
};
const A_OPTIONS = Object.keys(B_DICT);

/* -------------------- éš¨æ©Ÿè‰²èˆ‡å°æ¯”è‰² -------------------- */
const COLOR_POOL = ['#22d3ee','#a78bfa','#34d399','#f59e0b','#ef4444','#60a5fa','#f472b6','#84cc16','#eab308','#fb7185'];
function randomColor(){ return COLOR_POOL[Math.floor(Math.random()*COLOR_POOL.length)]; }
function textColorFor(hex){
  const c = hex.replace('#','');
  const r = parseInt(c.substring(0,2),16);
  const g = parseInt(c.substring(2,4),16);
  const b = parseInt(c.substring(4,6),16);
  const yiq = (r*299 + g*587 + b*114)/1000;
  return yiq >= 150 ? '#0b1220' : '#ffffff';
}
function darken(hex, factor=0.8){
  const c = hex.replace('#','');
  let r = Math.round(parseInt(c.substring(0,2),16)*factor);
  let g = Math.round(parseInt(c.substring(2,4),16)*factor);
  let b = Math.round(parseInt(c.substring(4,6),16)*factor);
  r = Math.max(0, Math.min(255, r));
  g = Math.max(0, Math.min(255, g));
  b = Math.max(0, Math.min(255, b));
  const toHex = v => v.toString(16).padStart(2,'0');
  return '#' + toHex(r) + toHex(g) + toHex(b);
}
/* -------------------- åˆå§‹åŒ–é¸å–® -------------------- */
function fillA(sel){
  sel.innerHTML = A_OPTIONS.map(v => `<option value="${v}">${v}</option>`).join('');
}
function fillB(sel, aValue){
  const arr = B_DICT[aValue] || [];
  sel.innerHTML = arr.map(v => `<option value="${v}">${v}</option>`).join('');
}

/* -------------------- å„²å­˜ / è¼‰å…¥ -------------------- */
function save(){ lsSet(LS_TIMERS, JSON.stringify(timers)); }
function load(){
  const raw = lsGet(LS_TIMERS);
  try{ timers = raw ? JSON.parse(raw) : []; }
  catch{ timers = []; }
}
function saveFormState(){
  const state = {
    quickA: $('#quickA').value,
    quickB: $('#quickB').value,
    dH: +$('#dH').value||0,
    dM: +$('#dM').value||0,
    dS: +$('#dS').value||0,
    lane: +$('#lane').value||1,
    leadMin: +$('#leadMin').value||0
  };
  lsSet(LS_FORM, JSON.stringify(state));
}
function loadFormState(){
  const raw = lsGet(LS_FORM);
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    if(s.quickA){ $('#quickA').value = s.quickA; fillB($('#quickB'), s.quickA); }
    if(s.quickB){ $('#quickB').value = s.quickB; }
    ['dH','dM','dS','lane','leadMin'].forEach(k=>{
      if(s[k]!==undefined) $('#'+k).value = s[k];
    });
  }catch{}
}

/* -------------------- æ™‚é–“æ ¼å¼ -------------------- */
function fmt(ms){
  if(ms<0) ms=0;
  const t = Math.floor(ms/1000);
  const h = Math.floor(t/3600).toString().padStart(2,'0');
  const m = Math.floor((t%3600)/60).toString().padStart(2,'0');
  const s = (t%60).toString().padStart(2,'0');
  return `${h}:${m}:${s}`;
}
function fmtClock(ts){
  const d = new Date(ts);
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}

/* -------------------- æ¸²æŸ“ -------------------- */
function render(){
  const now = Date.now();
  const sorted = [...timers].sort((x,y)=>{
    const rx = x.startAt + x.durationMs - now;
    const ry = y.startAt + y.durationMs - now;
    const ax = Math.max(rx, -1);
    const ay = Math.max(ry, -1);
    if (ax !== ay) return ax - ay; // å…ˆä¾å‰©é¤˜æ™‚é–“
    const ex = x.startAt + x.durationMs; // åˆ°é»æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
    const ey = y.startAt + y.durationMs;
    if (ex !== ey) return ex - ey; // æ¬¡è¦ï¼šåˆ°é»æ™‚é–“
    return (x.startAt ?? 0) - (y.startAt ?? 0); // æœ€å¾Œä¿éšªï¼šå»ºç«‹æ™‚é–“ï¼Œç¢ºä¿ç©©å®š
  });

  listEl.innerHTML = '';
  if(sorted.length===0){ emptyEl.style.display='block'; return; }
  emptyEl.style.display='none';

  sorted.forEach(t=>{
    const remain = t.startAt + t.durationMs - now;
    const soon = remain <= t.leadMin*60*1000 && remain>0;
    const expired = remain<=0;

    const card = document.createElement('div');
    card.className = 'card' + (soon?' soon':'') + (expired?' expired':'');
    const endAt = t.startAt + t.durationMs;

    // åˆ†æµè‰²æ¨£å¼
    const color = t.laneColor || '#a78bfa';
    const badgeBg = color;
    const badgeText = textColorFor(color);
    const borderCol = color;

    // è§£æ Lv èˆ‡ Boss åç¨±ã€Episode
    const lvLabel = (t.b.match(/Lv\.?\s*\d+/i) || [''])[0];
    const bossName = t.b.replace(/Lv\.?\s*\d+\s*-\s*/i, '').trim();
    const epNum = (t.a.match(/\d+/) || [0])[0];

    const stageBadge = t.stage ? `<span class="badge badge-stage">éšæ®µ ${t.stage}</span>` : '';
      card.innerHTML = `
      <div class="row2" style="align-items:flex-start;">
        <div class="title">
          <div class="labelGroup">
            <span class="badge badge-ep${String(epNum)}">${t.a}</span>
            ${ lvLabel ? '<span class="badge badge-lv">' + lvLabel + '</span>' : '' }
          </div>
          <div class="bossName" title="${bossName}">${bossName}</div>
          ${stageBadge}
          <span class="badge badge-lane">åˆ†æµ ${t.lane}</span>
        </div>
        <div class="tools">
          <button class="iconbtn" title="åˆªé™¤" data-del="${t.id}">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="row2">
        <div class="count">${fmt(remain)}</div>
        <div class="small">æé†’ï¼š${t.leadMin} åˆ†ï½œåˆ°é»ï¼š<span style="font-weight:700;letter-spacing:.3px">${fmtClock(endAt)}</span></div>
      </div>
    `;
card.classList.add('colored');
    card.style.setProperty('--card-accent', color);
    card.style.setProperty('--card-tint', hexToRgba(color, 0.08));
    // â€”â€” éšæ®µæŒ‰éˆ• â€”â€”
    const stageDiv = document.createElement('div');
    stageDiv.className = 'stage-buttons';
    for (let i = 1; i <= 4; i++) {
      const btn = document.createElement('button');
      const isActive = t.stage === i;
      btn.className = 'stage-btn' + (isActive ? ' active' : '');
      btn.textContent = i; // æ°¸é é¡¯ç¤ºæ•¸å­—
      btn.setAttribute('aria-pressed', String(isActive));
      btn.title = isActive ? `å–æ¶ˆéšæ®µ ${i}` : `è¨­å®šéšæ®µ ${i}`;
      btn.dataset.stageFor = t.id;
      btn.dataset.stageVal = i;
      stageDiv.appendChild(btn);
    }
    card.appendChild(stageDiv);


    listEl.appendChild(card);
  });
}

/* -------------------- è¨ˆæ™‚å¾ªç’° / æé†’ -------------------- */
function tick(){
  const now = Date.now();
  timers.forEach(t=>{
    
      // --- è‡ªç„¶è·¨é–¾å€¼åˆ¤å®šï¼ˆé¿å…è³‡æ–™è®Šå‹•å°è‡´é‡è¤‡è§¸ç™¼ï¼‰ ---
      const __remain = (t.startAt + t.durationMs) - now;
      const __prevRemain = (typeof t._lastRemain === 'number') ? t._lastRemain : null;
      const leadMs = (t.leadMin || 0) * 60 * 1000;
      const __naturalLead = (t.leadMin>0) && (__prevRemain !== null) && (__prevRemain > leadMs) && (__remain <= leadMs) && (__remain > 0);
      const __naturalExpiry = (__prevRemain !== null) && (__prevRemain > 0) && (__remain <= 0);
      t._lastRemain = __remain;
const alertAt = t.startAt + t.durationMs - t.leadMin*60*1000;
    if(!t.alert1Fired && __naturalLead){ t.alert1Fired = true; try{ beepEl.currentTime=0; beepEl.play(); }catch{} }
    if(!t.alert2Fired && now >= t.startAt + t.durationMs){
      if (__naturalExpiry) {
        t.alert2Fired = true; try{ beepEl.currentTime=0; beepEl.play(); }catch{}
        // è‡ªç„¶åˆ°é»æ‰è‡ªå‹•äº®éšæ®µ 1
        try{
          if (t.stage !== 1) {
            if (typeof SUPABASE_ENABLED !== 'undefined' && SUPABASE_ENABLED && typeof sb !== 'undefined' && sb){
              (async () => {
                try {
                  const { error } = await sb.from(SUPABASE_TABLE).update({ stage: 1 }).eq('id', t.id);
                  if (error) { console.error('è‡ªå‹•éšæ®µæ›´æ–°å¤±æ•—', error); }
                  t.stage = 1;
                  if (typeof render === 'function') { render(); }
                } catch (err) {
                  console.error('è‡ªå‹•éšæ®µæ›´æ–°ä¾‹å¤–', err);
                }
              })();
            } else {
              t.stage = 1;
              if (typeof save === 'function') { save(); }
            }
          }
        }catch(e){ console.error('è‡ªå‹•éšæ®µæ›´æ–°éŒ¯èª¤', e); }
      }
}
  });
  render();
}
setInterval(()=>{ $('#now').textContent = new Date().toLocaleString(); tick(); }, 1000);

/* -------------------- å»ºç«‹ / åˆªé™¤ -------------------- */
function addTimer(data){
  const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()+Math.random());
  timers.push({
    id,
    a: data.a,
    b: data.b,
    lane: +data.lane||1,
    laneColor: data.color || randomColor(),
    durationMs: ((+data.h||0)*3600 + (+data.m||0)*60 + (+data.s||0)) * 1000,
    leadMin: +data.lead||0,
    startAt: Date.now(),
    alert1Fired:false,
    alert2Fired:false,
    stage: 0
  });
  save(); render();
}
function deleteTimer(id){
  timers = timers.filter(t=>t.id!==id);
  save(); render();
}
listEl.addEventListener('click', (e)=>{
  const delId = e.target?.dataset?.del;
  if (delId) { window.deleteTimer(delId); return; }
  // éšæ®µæŒ‰éˆ•é»æ“Š
  if (e.target?.dataset?.stageFor) {
    const id = e.target.dataset.stageFor;
    const val = Number(e.target.dataset.stageVal);
    const t = timers.find(x => x.id === id);
    if (t) {
      const newStage = (t.stage === val) ? 0 : val;
      if (typeof SUPABASE_ENABLED !== 'undefined' && SUPABASE_ENABLED && typeof sb !== 'undefined' && sb){
        (async () => {
          try{
            const { error } = await sb.from(SUPABASE_TABLE).update({ stage: newStage }).eq('id', id);
            if (error){ console.error('é›²ç«¯æ›´æ–°éšæ®µå¤±æ•—', error); }
            await window.load(); render();
          }catch(err){ console.error(err); }
        })();
      }else{
        t.stage = newStage;
        save();
        render();
      }
    }
    return;
  }

});

/* -------------------- å¿«é€Ÿæ–°å¢ï¼ˆä¸å½ˆçª—ï¼‰ -------------------- */
let currentLaneColor = randomColor();
const laneSwatch = document.getElementById('laneSwatch');
function updateLaneSwatch(){
  laneSwatch.style.background = currentLaneColor;
  laneSwatch.title = `æ­¤æ¬¡åˆ†æµé¡è‰²ï¼š${currentLaneColor}`;
}
function quickAdd(){
  const data = {
    a: $('#quickA').value,
    b: $('#quickB').value,
    h: +$('#dH').value||0,
    m: +$('#dM').value||0,
    s: +$('#dS').value||0,
    lane: +$('#lane').value||1,
    lead: +$('#leadMin').value||0,
    color: currentLaneColor
  };
  if((data.h+data.m+data.s)===0){ alert('é‡ç”Ÿæ™‚é–“ä¸å¯ç‚º 0'); return; }
  addTimer(data);
  saveFormState();
  currentLaneColor = randomColor();
  updateLaneSwatch();
}

/* A è®Šå‹• â†’ B é‡å»º */
function hookCascade(aSel, bSel){
  aSel.addEventListener('change', ()=>{
    fillB(bSel, aSel.value);
    saveFormState();
  });
}
hookCascade($('#quickA'), $('#quickB'));

/* å¿«é€Ÿå€æŒ‰éˆ•èˆ‡å„²å­˜ */
document.getElementById('btnQuickAdd').addEventListener('click', quickAdd);
['#quickA','#quickB','#dH','#dM','#dS','#lane','#leadMin'].forEach(s=>{
  $(s).addEventListener('change', saveFormState);
  $(s).addEventListener('input', saveFormState);
});

/* æ¸…ç©º */
document.getElementById('btnClear').addEventListener('click', ()=>{
  if(confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è¨ˆæ™‚ï¼Ÿ')){ timers = []; save(); render(); }
});

/* -------------------- å•Ÿå‹• -------------------- */
function boot(){
  fillA($('#quickA')); fillB($('#quickB'), A_OPTIONS[0]);
  ['quickA','quickB'].forEach(id=>{
    const el = document.getElementById(id);
    el && el.addEventListener('change', ()=>{ el.blur && el.blur(); });
  });
  updateLaneSwatch();
  loadFormState(); load(); render();
}
boot();
</script>

<!-- Supabase integration (single-init) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL  = 'https://mqfcxoqwaqjofougkorh.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xZmN4b3F3YXFqb2ZvdWdrb3JoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NTY3NjksImV4cCI6MjA3MzUzMjc2OX0.d3C7nGN3_uLce0mFzSfKewR5TA_NaW-Lc1MYSd3K5pk';
const SUPABASE_TABLE = 'cards';
const SUPABASE_ENABLED = (SUPABASE_URL && SUPABASE_ANON && !/YOUR-/.test(SUPABASE_URL + SUPABASE_ANON));
const sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;

async function stableId(a,b,lane){
  const key = `${a}|${b}|${lane}`;
  if (window.crypto && window.crypto.subtle) {
    const enc = new TextEncoder().encode(key);
    const buf = await crypto.subtle.digest('SHA-1', enc);
    const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    return hex;
  }
  return 'id_'+key.replace(/[^a-z0-9]+/gi,'_');
}

if (SUPABASE_ENABLED && sb){
  console.log('[Supabase] enabled');

  // è¦†å¯« save/load
  window.save = function(){};
  window.load = async function(){
    const { data, error } = await sb.from(SUPABASE_TABLE).select('*');
    if (error){ console.error(error); return; }
    timers = (data||[]).map(row => ({
      id: row.id, a: row.a, b: row.b, lane: row.lane,
      laneColor: row.lane_color, durationMs: row.duration_ms,
      leadMin: row.lead_min, startAt: row.start_at ? (new Date(row.start_at)).getTime() : Date.now(),
      alert1Fired:false, alert2Fired:false, stage: row.stage ?? 0
    }));
  };

  // è¦†å¯« add/delete
  window.addTimer = async function(data){
    const id = await stableId(data.a, data.b, +data.lane||1);
    const payload = {
      id, a: data.a, b: data.b, lane: +data.lane||1,
      lane_color: data.color || currentLaneColor || '#999',
      duration_ms: ((+data.h||0)*3600 + (+data.m||0)*60 + (+data.s||0))*1000,
      lead_min: +data.lead||0, start_at: new Date().toISOString(), stage: 0
    };
    const { error } = await sb.from(SUPABASE_TABLE).upsert(payload);
    if (error){ alert('é›²ç«¯å¯«å…¥å¤±æ•—'); console.error(error); return; }
    await window.load(); render();
  };

  window.deleteTimer = async function(id){
    const { error } = await sb.from(SUPABASE_TABLE).delete().eq('id', id);
    if (error){ alert('åˆªé™¤å¤±æ•—'); console.error(error); return; }
    await window.load(); render();
  };

  // å–®ä¾‹ channel
  let cardsChannel = null;
  function listenRealtimeOnce(){
    if (cardsChannel) return;
    console.log('[Supabase] setting up realtime...');
    cardsChannel = sb.channel('cards-ch')
      .on('postgres_changes', { event: '*', schema: 'public', table: SUPABASE_TABLE }, (msg) => {
        if (msg.eventType === 'DELETE'){
          timers = timers.filter(t => t.id !== msg.old.id);
        }else{
          const row = msg.new;
          const t = {
            id: row.id, a: row.a, b: row.b, lane: row.lane,
            laneColor: row.lane_color, durationMs: row.duration_ms,
            leadMin: row.lead_min, startAt: row.start_at ? (new Date(row.start_at)).getTime() : Date.now(),
            alert1Fired:false, alert2Fired:false, stage: row.stage ?? 0
          };
          
const i = timers.findIndex(x=>x.id===t.id);
if (i>=0){
  const old = timers[i];
  if (old) {
    if (old.alert1Fired === true) t.alert1Fired = true;
    if (old.alert2Fired === true) t.alert2Fired = true;
    if (typeof old._lastRemain === 'number') t._lastRemain = old._lastRemain;
  }
  timers[i]=t;
} else {
  timers.push(t);
}

        }
        render();
      })
      .subscribe((status)=>console.log('[Supabase STATUS]', status));
  }

  // è¦†å¯« bootï¼šå…ˆè®“åŸæœ¬ boot åš UI åˆå§‹åŒ–ï¼Œå†æ¥ç®¡è³‡æ–™è¼‰å…¥èˆ‡ realtime
  const _boot = window.boot;
  window.boot = async function(){
    const origLoad = window.load, origRender = window.render;
    window.load = function(){}; window.render = function(){};
    try{ if (typeof _boot === 'function'){ _boot(); } } finally {
      window.load = origLoad; window.render = origRender;
    }
    await window.load(); render();
    listenRealtimeOnce();
  };

  // ç«‹å³å•Ÿå‹•ï¼ˆé¿å…åŸ boot å·²å…ˆè·‘å®Œï¼‰
  try{ window.boot(); }catch(e){ console.error('[Supabase] boot call failed', e); }
}else{
  console.warn('[Supabase] not enabledï¼Œç¹¼çºŒä½¿ç”¨ localStorage å–®æ©Ÿæ¨¡å¼ã€‚');
}
</script>

<script>
(function(){
  const KEY = 'timer_sound_enabled';
  const get = () => {
    try{
      const v = localStorage.getItem(KEY);
      return v === null ? true : JSON.parse(v);
    }catch(e){ return true; }
  };
  const set = (val) => {
    try{ localStorage.setItem(KEY, JSON.stringify(!!val)); }catch(e){}
    window.__soundEnabled = !!val;
    updateUI();
  };

  const chk = document.getElementById('soundToggleInput');
  const stateText = document.getElementById('soundStateText');
  function updateUI(){
    if(chk){ chk.checked = !!window.__soundEnabled; }
    if(stateText){ stateText.textContent = window.__soundEnabled ? 'é–‹' : 'é—œ'; }
  }

  window.__soundEnabled = get();
  updateUI();

  if(chk){
    chk.addEventListener('change', (e) => set(!!e.target.checked));
  }

  try{
    const proto = HTMLMediaElement && HTMLMediaElement.prototype;
    if(proto && !proto.__play_patched_for_timer_toggle__){
      const _play = proto.play;
      proto.play = function(...args){
        if(window.__soundEnabled === false){
          return Promise.resolve();
        }
        try{
          return _play.apply(this, args);
        }catch(err){
          return Promise.reject(err);
        }
      };
      Object.defineProperty(proto, '__play_patched_for_timer_toggle__', {value:true});
    }
  }catch(e){}
})();
</script>

</body>
</html>